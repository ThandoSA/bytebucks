<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs Board | Side Hustle Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .job-chat { border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; }
    .online-users { font-size: 12px; color: green; margin-bottom: 5px; }
    .chat-messages { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; background:#f9f9f9; }
    .chat-input { display: flex; gap: 5px; }
    .chat-input input { flex: 1; padding: 5px; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px 15px; border-radius: 5px; display: none; z-index: 9999; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="container header-container">
      <div class="logo">
        <h1><i class="ri-dashboard-line"></i> Side Hustle Hub - Jobs Board</h1>
      </div>
      <nav class="nav-desktop">
        <a href="index.html">Home</a>
        <a href="findwork.html">Find Work</a>
        <a href="postajob.html">Post Job</a>
        <a href="jobs.html" class="active">Jobs Board</a>
      </nav>
      <button id="logout-btn" class="btn logout-btn"><i class="ri-logout-box-r-line"></i> Logout</button>
    </div>
  </header>

  <!-- JOBS SECTION -->
  <section class="section">
    <h2>Available Jobs</h2>

    <!-- Filters -->
    <div class="filters">
      <input type="text" id="search-title" placeholder="Search by job title..." />
      <input type="text" id="search-location" placeholder="Search by location..." />
      <select id="filter-payment">
        <option value="">All Payments</option>
        <option value="Hourly">Hourly</option>
        <option value="Fixed">Fixed</option>
      </select>
      <select id="filter-availability">
        <option value="">All Availability</option>
        <option value="Full-time">Full-time</option>
        <option value="Part-time">Part-time</option>
      </select>
      <button id="filter-btn" class="btn"><i class="ri-filter-line"></i> Filter</button>
    </div>

    <div id="jobs-list" class="jobs-list"></div>
  </section>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io("https://bytebucks-api.onrender.com/"); // Connect to Socket.IO server

    const jobsList = document.getElementById("jobs-list");
    const searchTitle = document.getElementById("search-title");
    const searchLocation = document.getElementById("search-location");
    const filterPayment = document.getElementById("filter-payment");
    const filterAvailability = document.getElementById("filter-availability");
    const filterBtn = document.getElementById("filter-btn");
    const logoutBtn = document.getElementById("logout-btn");

    const username = localStorage.getItem("userName") || "Anonymous";
    const userType = localStorage.getItem("userType") || "hustler";

    let jobs = [];

    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Toast notification
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    // Fetch jobs
    async function fetchJobs() {
      try {
        const res = await fetch("https://bytebucks-api.onrender.com/");
        if (!res.ok) throw new Error("Failed to fetch jobs");
        jobs = await res.json();
        displayJobs(jobs);
        joinChatRooms();
      } catch (err) {
        console.error(err);
        jobsList.innerHTML = "<p>Unable to load jobs. Please try again later.</p>";
      }
    }

    // Display jobs with apply button and chat
    function displayJobs(list) {
      if (list.length === 0) {
        jobsList.innerHTML = "<p>No jobs found matching your criteria.</p>";
        return;
      }

      jobsList.innerHTML = list.map(job => {
        let applyBtn = "";
        if (userType === "hustler" && !(job.appliedBy?.includes(username))) {
          applyBtn = `<button class="btn apply-btn" data-id="${job._id}">Apply</button>`;
        } else if (userType === "hustler") {
          applyBtn = "<p>âœ… Applied</p>";
        }

        return `
          <div class="card">
            <h3>${job.title}</h3>
            <p><strong>Location:</strong> ${job.location}</p>
            <p><strong>Payment:</strong> R${job.payment}</p>
            <p><strong>Availability:</strong> ${job.availability}</p>
            <p>${job.description}</p>
            <p><em>Posted by: ${job.postedBy || "Anonymous"}</em></p>
            ${applyBtn}
            <div class="job-chat">
              <div class="online-users" id="online-users-${job._id}">Online: </div>
              <div class="chat-messages" id="chat-messages-${job._id}"></div>
              <div class="chat-input">
                <input type="text" id="chat-input-${job._id}" placeholder="Type a message..." />
                <button onclick="sendMessage('${job._id}')"><i class="ri-send-plane-line"></i></button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // Attach apply button events
      document.querySelectorAll(".apply-btn").forEach(button => {
        button.addEventListener("click", async (e) => {
          const jobId = e.target.dataset.id;
          try {
            const res = await fetch(`https://bytebucks-api.onrender.com/${jobId}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username })
            });
            const data = await res.json();
            if (res.ok) {
              showToast("Applied successfully!");
              fetchJobs(); // refresh
            } else {
              alert(data.message || "Failed to apply");
            }
          } catch (err) {
            console.error(err);
            alert("Server error. Try again later.");
          }
        });
      });
    }

    // Filter jobs
    filterBtn.addEventListener("click", () => {
      const filtered = jobs.filter(job => 
        (searchTitle.value === "" || job.title.toLowerCase().includes(searchTitle.value.toLowerCase())) &&
        (searchLocation.value === "" || job.location.toLowerCase().includes(searchLocation.value.toLowerCase())) &&
        (filterPayment.value === "" || job.payment === filterPayment.value) &&
        (filterAvailability.value === "" || job.availability === filterAvailability.value)
      );
      displayJobs(filtered);
      joinChatRooms();
    });

    // Join Socket.IO chat rooms
    function joinChatRooms() {
      jobs.forEach(job => {
        socket.emit("joinRoom", { room: job._id, user: username });
      });
    }

    // Listen for online users
    socket.on("updateUsers", ({ room, users }) => {
      const onlineDiv = document.getElementById(`online-users-${room}`);
      if (onlineDiv) onlineDiv.textContent = `Online: ${users.join(", ")}`;
    });

    // Listen for chat messages
    socket.on("chatMessage", ({ room, sender, message, time }) => {
      const msgDiv = document.getElementById(`chat-messages-${room}`);
      if (!msgDiv) return;

      const p = document.createElement("p");
      const timestamp = new Date(time).toLocaleTimeString();
      p.innerHTML = `<strong>${sender}</strong> [${timestamp}]: ${message}`;
      msgDiv.appendChild(p);
      msgDiv.scrollTop = msgDiv.scrollHeight;

      if (sender !== username) showToast(`New message from ${sender} in "${room}"`);
    });

    // Send chat message
    function sendMessage(room) {
      const input = document.getElementById(`chat-input-${room}`);
      const message = input.value.trim();
      if (!message) return;
      socket.emit("chatMessage", { room, sender: username, message });
      input.value = "";
    }

    fetchJobs();
  </script>
</body>
</html>
